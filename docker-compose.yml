services:
  # 1. The Target Machine (DVWA)
  dvwa:
    image: vulnerables/web-dvwa
    container_name: ghost_target
    ports:
      - "80:80"
      - "3306:3306"
      - "2222:22"
    environment:
      # CRITICAL: This allows the dashboard to display the target in the iframe
      - PHP_X_FRAME_OPTIONS=allow
    volumes:
      - ./dvwa_overrides/csrf_low.php:/var/www/html/vulnerabilities/csrf/source/low.php
      - ./dvwa_overrides/priv_esc/ghost-cron:/etc/cron.d/ghost-cron
      - ./dvwa_overrides/priv_esc/ghost-cleanup.sh:/usr/local/bin/ghost-cleanup.sh
      - ./dvwa_overrides/mysql/allow-remote.sql:/docker-entrypoint-initdb.d/allow-remote.sql
      - ./dvwa_overrides/ssh/enable-ssh.sh:/usr/local/bin/enable-ssh.sh
    command: bash -c "/usr/local/bin/enable-ssh.sh && /main.sh"
    networks:
      - cyber-range

  # 2. The Attack Machine (Kali + Shellinabox)
  kali:
    build: .
    container_name: ghost_terminal
    ports:
      - "8081:4200"
    networks:
      - cyber-range
    tty: true

  wetty:
    image: wettyoss/wetty
    container_name: ghost_wetty
    environment:
      - SSHHOST=ghost_target
      - SSHPORT=22
      - SSHUSER=root
      - SSHPASS=root
      - PORT=3000
    ports:
      - "3000:3000"
    networks:
      - cyber-range

  # 3. The Dashboard Server (Ghost Protocol interface)
  dashboard:
    image: python:3.11-slim
    container_name: ghost_dashboard
    ports:
      - "8082:8000"
    volumes:
      - ./ghost_protocol.html:/app/ghost_protocol.html
      - ./server.py:/app/server.py
    working_dir: /app
    command: bash -c "pip install flask --quiet && python server.py"
    networks:
      - cyber-range

networks:
  cyber-range:
    driver: bridge
